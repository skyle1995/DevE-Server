# 网络验证系统开发计划

## 文档版本控制

| 版本号 | 日期 | 修订人 | 修订内容 |
|-------|------|-------|--------|
| v1.0.0 | 2023-01-01 | 项目经理 | 初始版本 |
| v1.1.0 | 2023-01-15 | 技术主管 | 添加数据库设计 |
| v1.2.0 | 2023-02-01 | 开发工程师 | 更新API接口规范 |
| v1.3.0 | 2023-02-15 | 项目经理 | 更新项目时间线 |
| v1.4.0 | 2023-03-01 | 技术主管 | 添加配置文件管理 |
| v2.0.0 | 2023-03-15 | 项目团队 | 全面优化文档结构和内容 |

## 执行摘要

本文档详细描述了网络验证系统的开发计划，包括技术栈选择、项目结构、功能模块、开发阶段和时间安排。该系统主要包含用户后台核心模块，支持多应用管理，每个应用拥有独立的卡密和设备管理。通过8周的开发周期，将交付一个功能完善、性能稳定的网络验证系统，实现应用管理、卡密管理、系统设置等核心功能。

## 1. 项目概述

本项目旨在开发一个完整的网络验证系统，主要包含用户后台模块。系统将实现应用管理、卡密管理、系统设置等核心功能，提供安全、高效的验证服务。系统支持多应用管理，每个应用拥有独立的卡密和设备管理。

## 2. 技术栈

- **后端开发语言**：Golang
- **前端开发技术**：layui vue admin框架（Vue）
- **后端架构**：MVC（采用cobra+gin框架）
- **数据库**：MySql或SQLite（通过配置可选）
- **数据库引擎**：github.com/glebarez/sqlite（SQLite）
- **日志记录**：github.com/sirupsen/logrus
- **配置管理**：github.com/spf13/viper
- **配置文件格式**：YAML
- **静态资源**：使用embed打包编译
- **UI框架**：layui vue admin（开箱即用的 layui vue 企业级前端模板）

## 3. 项目结构

```
.
├── apps/               # 应用目录
│   ├── app/            # 应用管理模块
│   │   ├── model/      # 应用数据模型
│   │   ├── controller.go # 应用控制器
│   │   ├── service.go  # 应用业务逻辑
│   │   └── router.go   # 应用路由
│   ├── auth/           # 认证相关模块
│   │   ├── model/      # 认证数据模型
│   │   ├── controller.go # 认证控制器
│   │   └── service.go  # 认证业务逻辑
│   ├── card/           # 卡密管理模块
│   │   ├── model/      # 卡密数据模型
│   │   ├── controller.go # 卡密控制器
│   │   ├── service.go  # 卡密业务逻辑
│   │   └── router.go   # 卡密路由
│   ├── client/         # 客户端API模块
│   │   ├── model/      # 客户端数据模型
│   │   ├── controller.go # 客户端控制器
│   │   ├── service.go  # 客户端业务逻辑
│   │   └── router.go   # 客户端路由
│   ├── logs/           # 日志管理模块
│   │   ├── controller.go # 日志控制器
│   │   └── router.go   # 日志路由
│   ├── notice/         # 公告管理模块
│   │   ├── model/      # 公告数据模型
│   │   ├── controller.go # 公告控制器
│   │   ├── service.go  # 公告业务逻辑
│   │   └── router.go   # 公告路由
│   ├── setting/        # 系统设置模块
│   │   ├── model/      # 设置数据模型
│   │   ├── controller.go # 设置控制器
│   │   ├── service.go  # 设置业务逻辑
│   │   └── router.go   # 设置路由
│   └── user/           # 用户管理模块
│       ├── model/      # 用户数据模型
│       ├── controller.go # 用户控制器
│       ├── service.go  # 用户业务逻辑
│       └── router.go   # 用户路由
├── cmd/                # 命令行入口
│   ├── flags.go        # 命令行参数
│   ├── root.go         # 根命令
│   └── start.go        # 启动命令
├── config/             # 配置文件
│   ├── config.go       # 配置结构定义
│   └── config.yaml     # 配置文件
├── data/               # 数据目录
│   └── database.db     # SQLite数据库文件
├── database/           # 数据库模块
│   ├── database.go     # 数据库接口
│   ├── migration.go    # 数据库迁移
│   ├── model/          # 数据库模型
│   │   ├── apps.go     # 应用模型
│   │   ├── card.go     # 卡密模型
│   │   ├── device.go   # 设备模型
│   │   ├── logs.go     # 日志模型
│   │   ├── notice.go   # 公告模型
│   │   ├── setting.go  # 设置模型
│   │   └── user.go     # 用户模型
│   ├── mysql.go        # MySQL实现
│   ├── sqlite.go       # SQLite实现
│   └── utils.go        # 数据库工具
├── middleware/         # 中间件
│   ├── apps.go         # 应用中间件
│   ├── auth.go         # 认证中间件
│   ├── client.go       # 客户端中间件
│   └── logs.go         # 日志中间件
├── public/             # 前端资源
│   ├── dist/           # 编译后的前端资源
│   └── public.go       # 前端资源嵌入
├── server/             # 服务端
│   ├── router.go       # 主路由
│   └── server.go       # 服务器初始化
├── utils/              # 工具包
│   ├── cache/          # 缓存工具
│   ├── captcha/        # 验证码工具
│   ├── config/         # 配置工具
│   ├── convert/        # 类型转换工具
│   ├── crypto/         # 加密工具
│   ├── file/           # 文件操作工具
│   ├── http/           # HTTP工具
│   ├── jwt/            # JWT工具
│   ├── logger/         # 日志工具
│   ├── pagination/     # 分页工具
│   ├── qqwry/          # 纯真IP工具
│   ├── random/         # 随机生成工具
│   ├── response/       # 响应工具
│   ├── timeutil/       # 时间工具
│   └── validator/      # 验证工具
├── go.mod              # Go模块定义
├── go.sum              # 依赖校验
├── .gitignore          # Git忽略文件
├── main.go             # 程序入口
└── 开发文档.md          # 开发文档
```

### 3.1 目录结构说明

#### apps 目录
这是应用的核心目录，采用领域驱动设计思想，按功能模块划分：

- **app**: 应用管理模块，负责应用的创建、配置、查询和管理
- **auth**: 处理所有认证相关功能，包括登录、注册、权限验证等
- **card**: 卡密管理模块，负责卡密的生成、激活、查询和管理
- **client**: 客户端API模块，提供给客户端应用调用的接口
- **logs**: 日志管理模块，记录系统操作日志和客户端请求日志
- **notice**: 公告管理模块，负责系统公告和应用公告的管理
- **setting**: 系统设置模块，负责全局配置和参数设置
- **user**: 用户管理模块，负责用户账户的创建和管理

每个模块内部遵循MVC架构，包含：
- **controller.go**: 处理HTTP请求，参数验证，调用service层
- **service.go**: 实现业务逻辑，调用数据库模型层
- **model/**: 请求和响应数据模型定义
  - **request.go**: 请求数据结构定义
  - **response.go**: 响应数据结构定义
- **router.go**: 模块路由定义

#### database 目录
数据库相关功能，支持MySQL和SQLite：

- **database.go**: 数据库接口定义
- **migration.go**: 数据库迁移和初始化
- **mysql.go**: MySQL数据库实现
- **sqlite.go**: SQLite数据库实现
- **utils.go**: 数据库工具函数
- **model/**: 数据库模型定义
  - **apps.go**: 应用表模型
  - **card.go**: 卡密表模型
  - **device.go**: 设备表模型
  - **logs.go**: 日志表模型
  - **notice.go**: 公告表模型
  - **setting.go**: 设置表模型
  - **user.go**: 用户表模型

#### middleware 目录
中间件用于处理横切关注点，如认证、日志记录、错误处理等：

- **apps.go**: 应用相关中间件
- **auth.go**: 身份验证中间件，验证用户登录状态和权限
- **client.go**: 客户端API中间件，处理客户端请求验证
- **logs.go**: 请求日志记录中间件

#### utils 目录
通用工具函数，提高代码复用性：

- **cache/**: 缓存工具
- **captcha/**: 验证码工具
- **config/**: 配置工具
- **convert/**: 类型转换工具
- **crypto/**: 加密解密、哈希等安全相关功能
- **file/**: 文件操作工具
- **http/**: HTTP请求工具
- **ip/**: IP地址工具
- **jwt/**: JWT认证工具
- **logger/**: 日志记录工具
- **pagination/**: 分页工具
- **random/**: 随机生成工具
- **response/**: 统一API响应格式处理
- **timeutil/**: 时间处理工具
- **validator/**: 数据验证工具

#### public 目录
前端资源文件，使用embed打包：

- **dist/**: 编译后的前端资源
- **public.go**: 前端资源嵌入代码

## 4. 开发阶段

### 阶段一：项目初始化与基础架构搭建（1周）

- 初始化项目结构
- 配置开发环境
- 实现基础框架搭建
- 设计数据库模型
- 实现基础中间件（日志、认证等）

### 阶段二：核心功能开发（2周）

#### 认证模块
- 用户认证系统
- 权限管理系统

#### 数据库模块
- 数据库连接配置
- 数据模型定义
- 数据访问层实现

#### 配置文件模块
- 配置结构定义
- 默认配置文件embed打包实现
- 配置文件自动释放机制
- 配置热加载功能

### 阶段三：用户后台开发（2周）

- 仪表盘（展示卡密信息、系统状态等）
- 卡密管理（增加、删除、编辑）
- 卡密设置（类型设置、长度设置）
- 日志管理（登录日志、操作日志）
- 系统设置（参数设置、日志设置、配置管理）

### 阶段四：前端开发与UI优化（2周）

- 响应式布局设计
- 基于Pear Admin Layui框架的现代化UI实现
  - Pear Admin Layui组件集成与定制
  - 多主题切换与风格统一设计
  - 布局方案配置（多标签页/单页面）
- 前端交互优化
  - 数据表格与表单交互组件应用
  - 异步Ajax菜单构建
  - 多标签页与单标签页共存
- 页面性能优化
  - 资源按需加载
  - 组件懒加载策略
  - 前端资源打包优化
- 前端资源分类管理
  - 全局资源与框架资源分离（assets与pear-admin）
  - Pear Admin目录结构规范化
  - 配置文件统一管理（pear.config.json）
  - 视图与组件分离

### 阶段五：测试与部署（1周）

- 单元测试
- 集成测试
- 性能测试
- 部署文档编写
- 系统部署

## 5. 功能模块详细规划

### 5.1 用户后台

#### 仪表盘
- 应用统计信息展示
- 卡密使用情况统计
- 系统运行状态监控
- 重要日志实时展示

#### 应用管理
- 应用创建与配置
- 应用列表查看
- 应用状态管理
- 应用密钥管理
- 应用详情查看
- 应用变量管理（公开/私有）
- 应用接口安全设置

#### 卡密管理
- 卡密生成与批量生成
- 卡密列表查看（按应用筛选）
- 卡密状态管理
- 卡密详情查看
- 卡密导出功能

#### 用户设置
- 登录策略设置
- 权限模板管理
- 用户默认设置
- 密码策略设置

#### 卡密设置
- 卡密类型管理（按应用）
- 卡密生成规则设置
- 卡密有效期设置
- 卡密批量操作设置

#### 日志管理
- 登录日志查询与导出
- 操作日志查询与导出
- 日志清理策略设置

#### 系统设置
- 基础参数配置
- 安全策略设置
- 应用默认配置
- 备份与恢复
- 系统维护功能
- 全局变量管理
- 全局公告管理
- 接口安全策略



## 6. 技术要点与注意事项

1. **前端开发**：
   - 确保UI设计现代化、美观，并支持响应式布局
   - 采用优化的前端资源目录结构：
     - assets目录：全局静态资源（css/js/images）
     - pear-admin目录：Pear Admin Layui框架
       - component：组件资源（layui核心框架/pear扩展组件）
       - config：配置文件（pear.config.json等）
       - view：视图文件（console/system/result/error等）
     - templates目录：Go模板文件，按用途分类（admin/user）
   - Pear Admin Layui框架应用：
     - 使用配置文件统一管理系统布局与主题
     - 利用Pear Admin扩展组件提高开发效率
     - 支持多标签页与单页面布局切换
     - 实现多主题切换功能，提升用户体验
     - 使用异步Ajax构建菜单，提高系统响应速度
2. **安全性**：实现完善的认证机制和权限控制
3. **性能优化**：数据库查询优化，缓存策略实施
4. **日志记录**：完善的日志记录系统，便于问题排查
5. **配置灵活**：支持MySQL和SQLite数据库切换
6. **配置文件管理**：
   - 默认配置文件（default.yaml）通过embed打包编译到程序中
   - 程序启动时检查外部config.yaml是否存在
   - 如果外部config.yaml不存在，自动释放内置default.yaml为config.yaml
   - 支持用户通过修改外部config.yaml自定义配置
7. **代码规范**：遵循Go语言编码规范，保持代码可读性和可维护性
8. **路由组织**：用户后台使用清晰的路由结构

## 7. 项目里程碑

1. **基础架构完成**：项目框架搭建完毕，基础功能可运行
2. **用户后台完成**：用户所有功能模块开发完成
3. **UI优化完成**：前端界面美观，响应式布局实现
4. **测试完成**：所有功能测试通过，系统稳定运行
5. **部署上线**：系统成功部署，可供使用

## 8. 用户权限管理

系统中用户分为三种角色：系统管理员（role=0）、普通会员（role=1）和VIP会员（role=2），它们具有不同的权限范围：

### 系统管理员权限

1. **用户管理**：可以创建、查看、编辑和删除所有用户账户
2. **系统数据统计**：可以查看整个系统的数据统计信息
3. **系统设置**：可以修改系统全局配置
4. **全部数据访问**：可以访问和管理系统中的所有数据，包括所有用户创建的应用、卡密、设备等

### 普通会员权限

1. **个人数据管理**：只能查看和管理自己创建的数据
   - 只能查看和管理自己创建的应用
   - 只能查看和管理自己创建的卡密
   - 只能查看和管理与自己应用关联的设备
2. **功能限制**：无法访问系统管理员专有的功能和接口
   - 无法访问用户管理功能
   - 无法访问系统数据统计功能

### VIP会员权限

1. **扩展的个人数据管理**：除了普通会员的权限外，还有以下特权
   - 可以创建更多的应用（数量上限更高）
   - 享有更高的API调用频率限制
   - 可以使用高级功能（如数据导出、批量操作等）
2. **优先支持**：获得优先的技术支持和问题解决
   - 无法修改系统全局配置

### 接口权限控制

1. **用户账户管理API**：仅系统管理员可访问
2. **数据访问控制**：所有数据相关API都会根据当前登录用户的角色和ID进行权限过滤
   - 系统管理员可以查看和管理所有数据
   - 普通会员和VIP会员只能查看和管理与自己关联的数据
3. **前端界面控制**：根据用户角色动态显示或隐藏功能模块
   - 系统管理员可以看到所有功能模块
   - 普通会员和VIP会员看不到管理员专有的功能模块

## 9. 开发环境与工具

- **开发语言**：Go 1.16+
- **开发工具**：GoLand/VSCode
- **版本控制**：Git
- **数据库**：MySQL 5.7/SQLite 3
- **API测试**：Postman
- **前端框架**：Pear Admin Layui（基于Layui 2.8+）
- **前端工具**：VSCode + Layui扩展
- **前端构建**：可选使用gulp.js进行资源打包

## 10. 风险评估与应对策略

| 风险 | 可能性 | 影响 | 应对策略 |
|------|--------|------|----------|
| 需求变更 | 中 | 高 | 采用敏捷开发方法，保持与需求方沟通 |
| 技术难题 | 中 | 中 | 提前调研关键技术点，准备备选方案 |
| 进度延迟 | 中 | 高 | 合理规划时间，设置缓冲期 |
| 安全漏洞 | 低 | 高 | 代码审查，安全测试 |
| 性能问题 | 中 | 中 | 早期进行性能测试，识别瓶颈 |

## 11. 数据库设计

### 11.1 ER图

```
+-------------+       +-------------+       +-------------+       +-------------+
|    user     |       |    apps     |       | card_types  |       |    cards    |
+-------------+       +-------------+       +-------------+       +-------------+
| id          |<----->| id          |<----->| id          |<----->| id          |
| username    |       | name        |       | name        |       | card_no     |
| password    |       | app_key     |       | duration    |       | card_secret |
| email       |       | app_secret  |       | time_unit   |       | type_id     |
| nickname    |       | status      |       | price       |       | app_id      |
| avatar      |       | version     |       | status      |       | user_id     |
| status      |       | device_binding|      | app_id      |       | status      |
| role        |       | billing_mode |      | user_id     |       | device_id   |
| last_login  |       | user_id     |       | created_at  |       | binding_info|
| created_at  |       | created_at  |       | updated_at  |       | activate_time|
| updated_at  |       | updated_at  |       | deleted_at  |       | expire_time |
| deleted_at  |       | deleted_at  |       +-------------+       | created_at  |
+-------------+       +-------------+                             | updated_at  |
                            |                                     | deleted_at  |
                            |                                     +-------------+
                            v                                            ^
                      +-------------+                                    |
                      |   devices   |                                    |
                      +-------------+                                    |
                      | id          |------------------------------------+
                      | device_id   |
                      | device_name |
                      | device_type |
                      | device_os   |
                      | device_ip   |
                      | device_info |
                      | last_active |
                      | status      |
                      | app_id      |
                      | created_at  |
                      | updated_at  |
                      | deleted_at  |
                      +-------------+
                            ^
                            |
                      +-------------+       +-------------+
                      |    logs     |       |   notices   |
                      +-------------+       +-------------+
                      | id          |       | id          |
                      | type        |       | title       |
                      | app_id      |       | content     |
                      | user_id     |       | level       |
                      | method      |       | status      |
                      | path        |       | start_time  |
                      | ip          |       | end_time    |
                      | user_agent  |       | user_id     |
                      | status_code |       | created_at  |
                      | latency     |       | updated_at  |
                      | request_body|       | deleted_at  |
                      | response_body|      +-------------+
                      | content     |
                      | created_at  |
                      | updated_at  |
                      | deleted_at  |
                      +-------------+
```

### 11.2 主要表结构

#### user表
```sql
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码（加密存储）',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `role` tinyint(1) NOT NULL DEFAULT 1 COMMENT '角色：0-系统管理员，1-普通会员，2-VIP会员',
  `last_login` datetime DEFAULT NULL COMMENT '最后登录时间',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### apps表
```sql
CREATE TABLE `apps` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '应用名称',
  `description` text DEFAULT NULL COMMENT '应用描述',
  `app_key` varchar(64) NOT NULL COMMENT '应用密钥',
  `app_secret` varchar(64) NOT NULL COMMENT '应用密钥',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `version` varchar(20) DEFAULT NULL COMMENT '应用当前版本',
  `download_url` varchar(255) DEFAULT NULL COMMENT '应用下载地址',
  `logo` varchar(255) DEFAULT NULL COMMENT '应用logo URL',
  `website` varchar(255) DEFAULT NULL COMMENT '应用官网地址',
  `contact` varchar(255) DEFAULT NULL COMMENT '联系方式',
  `notice` text DEFAULT NULL COMMENT '应用公告内容',
  `public_data` text DEFAULT NULL COMMENT '公有数据（JSON格式）',
  `private_data` text DEFAULT NULL COMMENT '私有数据（JSON格式）',
  `device_binding` tinyint(1) NOT NULL DEFAULT 0 COMMENT '绑定类型：0-不绑定，1-设备绑定，2-IP绑定',
  `billing_mode` tinyint(1) NOT NULL DEFAULT 0 COMMENT '计费模式：0-按时间，1-按次数',
  `allow_trial` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否允许试用：0-不允许，1-允许',
  `trial_quota` int(11) DEFAULT 0 COMMENT '试用额度（时间或次数）',
  `max_devices` int(11) DEFAULT 0 COMMENT '最大设备数，0表示不限制',
  `heartbeat` int(11) DEFAULT 0 COMMENT '心跳间隔（分钟），0表示不需要心跳',
  `bind_permission` tinyint(1) NOT NULL DEFAULT 0 COMMENT '绑定权限：0-不允许换绑和解绑，1-允许换绑，2-允许解绑，3-允许换绑和解绑',
  `unbind_deduct_hours` int(11) DEFAULT 0 COMMENT '解绑扣除时长（小时），0表示不扣除',
  `encryption_type` tinyint(1) NOT NULL DEFAULT 0 COMMENT '加密类型：0-不加密，1-AES加密，2-RSA加密，3-自定义加密',
  `encryption_key` varchar(255) DEFAULT NULL COMMENT '加密密钥',
  `signature_required` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否需要签名：0-不需要，1-需要',
  `signature_algorithm` varchar(20) DEFAULT NULL COMMENT '签名算法：MD5/SHA1/SHA256等',
  `signature_key` varchar(255) DEFAULT NULL COMMENT '签名密钥',
  `ip_whitelist` text DEFAULT NULL COMMENT 'IP白名单，多个IP用逗号分隔，为空表示不限制',
  `request_rate_limit` int(11) NOT NULL DEFAULT 0 COMMENT '请求频率限制（次/分钟），0表示不限制',
  `timeout` int(11) NOT NULL DEFAULT 60 COMMENT '请求超时时间（秒）',
  `user_id` int(11) NOT NULL COMMENT '创建者用户ID',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_app_key` (`app_key`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='应用表';
```



#### card_types表
```sql
CREATE TABLE `card_types` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '类型名称',
  `duration` int(11) NOT NULL COMMENT '有效时长',
  `time_unit` tinyint(1) NOT NULL DEFAULT 1 COMMENT '时间单位：0-小时，1-天，2-月，3-年',
  `price` decimal(10,2) DEFAULT 0.00 COMMENT '价格',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `app_id` int(11) NOT NULL COMMENT '所属应用ID',
  `user_id` int(11) NOT NULL COMMENT '创建者用户ID',
  `default_max_rebind` int(11) NOT NULL DEFAULT 0 COMMENT '默认最大换绑次数，0表示不限制',
  `default_max_unbind` int(11) NOT NULL DEFAULT 0 COMMENT '默认最大解绑次数，0表示不限制',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='卡密类型表';
```

#### cards表
```sql
CREATE TABLE `cards` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `card_no` varchar(50) NOT NULL COMMENT '卡密号',
  `card_secret` varchar(50) DEFAULT NULL COMMENT '卡密密钥',
  `type_id` int(11) NOT NULL COMMENT '卡密类型ID',
  `app_id` int(11) NOT NULL COMMENT '所属应用ID',
  `user_id` int(11) NOT NULL COMMENT '创建者用户ID',
  `status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '状态：0-未使用，1-已使用，2-已过期，3-已禁用',
  `device_id` varchar(100) DEFAULT NULL COMMENT '使用设备ID',
  `binding_info` text DEFAULT NULL COMMENT '绑定信息（JSON格式，根据应用的绑定类型存储设备ID或IP地址）',
  `rebind_count` int(11) NOT NULL DEFAULT 0 COMMENT '换绑次数统计',
  `unbind_count` int(11) NOT NULL DEFAULT 0 COMMENT '解绑次数统计',
  `max_rebind` int(11) NOT NULL DEFAULT 0 COMMENT '最大换绑次数，0表示不限制',
  `max_unbind` int(11) NOT NULL DEFAULT 0 COMMENT '最大解绑次数，0表示不限制',
  `activate_time` datetime DEFAULT NULL COMMENT '激活时间',
  `expire_time` datetime DEFAULT NULL COMMENT '过期时间',
  `online` tinyint(1) NOT NULL DEFAULT 0 COMMENT '在线状态：0-离线，1-在线',
  `last_heartbeat` datetime DEFAULT NULL COMMENT '最后心跳时间',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_card_no` (`card_no`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_type_id` (`type_id`),
  KEY `idx_status` (`status`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_device_id` (`device_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='卡密表';
```

#### devices表
```sql
CREATE TABLE `devices` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `device_id` varchar(100) NOT NULL COMMENT '设备唯一标识',
  `device_name` varchar(100) DEFAULT NULL COMMENT '设备名称',
  `device_type` varchar(50) DEFAULT NULL COMMENT '设备类型',
  `device_os` varchar(50) DEFAULT NULL COMMENT '设备操作系统',
  `device_ip` varchar(50) DEFAULT NULL COMMENT '设备IP地址',
  `device_info` text DEFAULT NULL COMMENT '设备信息（JSON格式）',
  `last_active` datetime DEFAULT NULL COMMENT '最后活跃时间',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `app_id` int(11) NOT NULL COMMENT '所属应用ID',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_device_id` (`device_id`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备表';
```

#### settings表
```sql
CREATE TABLE `settings` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `key` varchar(50) NOT NULL COMMENT '设置键名',
  `value` text NOT NULL COMMENT '设置值',
  `description` varchar(255) DEFAULT NULL COMMENT '设置描述',
  `group` varchar(50) NOT NULL DEFAULT 'general' COMMENT '设置分组',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_key` (`key`),
  KEY `idx_group` (`group`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统设置表';
```

#### logs表
```sql
CREATE TABLE `logs` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `type` tinyint(1) NOT NULL DEFAULT 0 COMMENT '日志类型：0-登录日志，1-操作日志，2-系统日志，3-应用日志',
  `app_id` int(11) DEFAULT NULL COMMENT '应用ID',
  `user_id` int(11) DEFAULT NULL COMMENT '用户ID',
  `method` varchar(10) DEFAULT NULL COMMENT '请求方法',
  `path` varchar(255) DEFAULT NULL COMMENT '请求路径',
  `ip` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(255) DEFAULT NULL COMMENT '用户代理',
  `status_code` int(11) DEFAULT NULL COMMENT '状态码',
  `latency` int(11) DEFAULT NULL COMMENT '请求耗时（毫秒）',
  `request_body` text DEFAULT NULL COMMENT '请求内容',
  `response_body` text DEFAULT NULL COMMENT '响应内容',
  `content` text DEFAULT NULL COMMENT '日志内容',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  KEY `idx_type` (`type`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='日志表';
```

#### notices表
```sql
CREATE TABLE `notices` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `title` varchar(100) NOT NULL COMMENT '通知标题',
  `content` text NOT NULL COMMENT '通知内容',
  `level` tinyint(1) NOT NULL DEFAULT 0 COMMENT '通知级别：0-普通，1-重要，2-紧急',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `start_time` datetime DEFAULT NULL COMMENT '开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '结束时间',
  `user_id` int(11) NOT NULL COMMENT '创建者用户ID',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间（软删除）',
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_level` (`level`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_end_time` (`end_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统通知表';
```

## 12. API接口规范

### 12.1 请求/响应格式

所有API请求和响应均采用JSON格式，UTF-8编码。

#### 请求格式
```json
{
  "data": {}, // 请求数据（当启用加密时，此字段为加密后的base64字符串）
  "timestamp": 1629789600, // 请求时间戳
  "app_key": "xxxx", // 应用密钥（客户端API必填）
  "sign": "xxxx" // 签名（当应用开启签名验证时必填）
}
```

#### 响应格式
```json
{
  "code": 200, // 状态码：200-成功，非200-失败
  "message": "success", // 状态描述
  "data": {}, // 响应数据（当启用加密时，此字段为加密后的base64字符串）
  "timestamp": 1629789600, // 响应时间戳
  "sign": "xxxx" // 签名（当应用开启签名验证时返回）
}
```

#### 加密请求示例
当应用开启加密时，请求和响应的data字段将被加密：

```json
{
  "data": "U2FsdGVkX1+9X5NwSsA76...", // 加密后的base64字符串
  "timestamp": 1629789600,
  "app_key": "xxxx",
  "sign": "xxxx"
}
```

请求头需添加：
```
Content-Encoding: encrypted
```

### 12.2 状态码

#### 成功状态码

| 状态码 | 描述 |
|--------|------|
| 200 | 成功 |

#### 通用错误（1000-1999）

| 状态码 | 描述 |
|--------|------|
| 1001 | 参数错误 |
| 1002 | 未授权 |
| 1003 | 权限不足 |

#### 用户相关错误（2000-2999）

| 状态码 | 描述 |
|--------|------|
| 2001 | 用户名或密码错误 |
| 2002 | 用户账号已禁用 |

#### 卡密相关错误（3000-3999）

| 状态码 | 描述 |
|--------|------|
| 3001 | 卡密不存在 |
| 3002 | 卡密已使用 |
| 3003 | 卡密已过期 |
| 3004 | 卡密已禁用 |
| 3005 | 卡密已达到最大换绑/解绑次数 |
| 3006 | 卡密设备ID不匹配 |

#### 应用相关错误（4000-4999）

| 状态码 | 描述 |
|--------|------|
| 4001 | 应用密钥无效 |
| 4002 | 应用已禁用 |
| 4003 | 卡密不属于该应用 |
| 4004 | 心跳验证失败 |
| 4005 | 应用要求绑定验证 |
| 4006 | 卡密已绑定其他设备或IP |
| 4007 | 设备或IP未通过绑定验证 |
| 4013 | 心跳间隔时间过短 |

#### 安全相关错误（4008-4099）

| 状态码 | 描述 |
|--------|------|
| 4008 | 签名验证失败 |
| 4009 | 加密/解密错误 |
| 4010 | 请求超时（时间戳验证失败） |
| 4011 | IP不在白名单中 |
| 4012 | 请求频率超限 |

#### 服务器错误（5000-5999）

| 状态码 | 描述 |
|--------|------|
| 5001 | 服务器内部错误 |

### 12.3 认证机制

#### 用户后台认证

用户后台采用JWT（JSON Web Token）进行身份验证：

1. 用户通过登录接口获取token
2. 后续请求在Header中携带token：`Authorization: Bearer {token}`
3. token有效期为24小时，过期需重新登录

##### 用户登录
```
POST /api/panel/login
```
请求参数：
```json
{
  "username": "admin",
  "password": "password"
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expire": 86400,
    "user": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "role": 0,
      "status": 1
    }
  }
}
```

#### 用户账户管理API

##### 获取当前用户权限
```
GET /api/v1/permission
```
请求参数：无

响应：
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "role": 0,
    "role_name": "管理员",
    "permissions": {
      "can_manage_users": true,
      "can_access_vip_features": true
    }
  }
}
```

> 注意：以下API接口仅系统管理员（role=0）可以访问，普通会员（role=1）和VIP会员（role=2）无权访问

##### 创建用户账户
```
POST /api/panel/users
```
请求参数：
```json
{
  "username": "user1",
  "password": "password",
  "email": "user1@example.com",
  "role": 1,
  "status": 1
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 2,
    "username": "user1",
    "email": "user1@example.com",
    "role": 1,
    "status": 1,
    "create_time": "2023-01-01 12:00:00"
  }
}
```

##### 获取用户账户列表
```
GET /api/panel/users
```
请求参数：
```
role: 1  // 可选，角色：0-系统管理员，1-普通会员，2-VIP会员，不传表示获取所有角色
status: 1  // 可选，状态：0-禁用，1-启用，不传表示获取所有状态
page: 1  // 可选，页码，默认1
limit: 20  // 可选，每页数量，默认20
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "list": [
      {
        "id": 1,
        "username": "admin",
        "email": "admin@example.com",
        "role": 0,
        "status": 1,
        "create_time": "2023-01-01 12:00:00",
        "update_time": "2023-01-02 12:00:00"
      },
      {
        "id": 2,
        "username": "user1",
        "email": "user1@example.com",
        "role": 1,
        "status": 1,
        "create_time": "2023-01-01 12:00:00",
        "update_time": null
      }
    ]
  }
}
```

##### 更新用户账户
```
PUT /api/panel/users/{id}
```
请求参数：
```json
{
  "email": "user1_new@example.com",
  "password": "new_password",  // 可选，不修改密码时可不传
  "status": 1
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 2,
    "username": "user1",
    "email": "user1_new@example.com",
    "role": 1,
    "status": 1,
    "update_time": "2023-01-02 12:00:00"
  }
}
```

##### 删除用户账户
```
DELETE /api/panel/users/{id}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

#### 客户端API认证

客户端API采用应用密钥（app_key）进行身份验证，并支持加密和签名：

1. **基础认证**：
   - 每个应用拥有唯一的应用密钥
   - 客户端请求需在请求体中携带应用密钥
   - 服务端验证应用密钥的有效性和状态

2. **请求签名**（当应用开启签名验证时）：
   - 客户端按照签名流程生成签名
   - 请求参数中必须包含sign字段
   - 服务端验证签名的有效性

3. **数据加密**（当应用开启加密时）：
   - 根据应用设置的加密类型进行数据加密
   - 加密后的数据以base64编码形式传输
   - 请求头需添加`Content-Encoding: encrypted`

4. **时间戳验证**：
   - 请求必须包含timestamp字段

5. **IP地址获取**：
   - 服务端自动从请求中获取客户端IP地址
   - 优先从HTTP头（X-Forwarded-For、X-Real-IP等）获取
   - 当应用设置为IP绑定时，获取的IP用于绑定验证
   - 服务端验证请求时间戳与服务器时间的差值是否在允许范围内（默认5分钟）
   - 防止重放攻击

5. **IP白名单**（当应用设置了IP白名单时）：
   - 服务端验证请求IP是否在白名单中
   - 非白名单IP的请求将被拒绝

### 12.4 主要API接口

#### 应用管理API

##### 创建应用
```
POST /api/panel/applications
```
请求参数：
```json
{
  "name": "应用名称",
  "description": "应用描述",
  "device_binding": 0,  // 绑定类型：0-不绑定，1-设备绑定，2-IP绑定
  "logo_url": "https://example.com/logo.png",  // 应用logo URL
  "version": "1.0.0",  // 应用当前版本
  "download_url": "https://example.com/download",  // 应用下载地址
  "website_url": "https://example.com",  // 应用官网地址
  "contact_info": "contact@example.com",  // 联系方式
  "notice": "应用公告内容",  // 应用公告
  "allow_trial": 1,  // 是否允许试用：0-不允许，1-允许
  "trial_amount": 168,  // 试用额度（时长计费模式下为小时数，点数计费模式下为点数）
  "max_devices": 3,  // 最大设备数，0表示不限制
  "heartbeat": 30,  // 心跳间隔（分钟），0表示不需要心跳
  "allow_rebind": 0,  // 是否允许换绑：0-不允许，1-允许
  "allow_unbind": 0,  // 是否允许解绑：0-不允许，1-允许
  "unbind_deduct_hours": 0,  // 解绑扣除时长（小时），0表示不扣除
  "encryption_type": 1,  // 加密类型：0-不加密，1-AES加密，2-RSA加密，3-自定义加密
  "encryption_key": "加密密钥",  // 加密密钥
  "signature_required": 1,  // 是否需要签名：0-不需要，1-需要
  "signature_algorithm": "MD5",  // 签名算法：MD5/SHA1/SHA256等
  "signature_key": "签名密钥",  // 签名密钥
  "ip_whitelist": "192.168.1.1,192.168.1.2",  // IP白名单，多个IP用逗号分隔，为空表示不限制
  "request_rate_limit": 100,  // 请求频率限制（次/分钟），0表示不限制
  "timeout": 60  // 请求超时时间（秒）
  // admin_id 由系统根据当前登录的用户自动设置
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "应用名称",
    "app_key": "生成的应用密钥",
    "device_binding": 0,
    "status": 1,
    "description": "应用描述",
    "logo_url": "https://example.com/logo.png",
    "version": "1.0.0",
    "download_url": "https://example.com/download",
    "website_url": "https://example.com",
    "contact_info": "contact@example.com",
    "notice": "应用公告内容",
    "allow_trial": 1,
    "trial_amount": 168,
    "max_devices": 3,
    "heartbeat": 30,
    "allow_rebind": 0,
    "allow_unbind": 0,
    "unbind_deduct_hours": 0,
    "encryption_type": 1,
    "encryption_key": "加密密钥",
    "signature_required": 1,
    "signature_algorithm": "MD5",
    "signature_key": "签名密钥",
    "ip_whitelist": "192.168.1.1,192.168.1.2",
    "request_rate_limit": 100,
    "timeout": 60,
    "admin_id": 1,
    "create_time": "2023-01-01 12:00:00"
  }
}
```

##### 获取应用列表
```
GET /api/panel/applications
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "list": [
      {
        "id": 1,
        "name": "应用1",
        "app_key": "应用密钥",
        "device_binding": 0,
        "status": 1,
        "description": "应用描述",
        "logo_url": "https://example.com/logo.png",
        "version": "1.0.0",
        "download_url": "https://example.com/download",
        "website_url": "https://example.com",
        "contact_info": "contact@example.com",
        "notice": "应用公告内容",
        "allow_trial": 1,
        "trial_amount": 168,
        "max_devices": 3,
        "heartbeat": 30,
        "allow_rebind": 0,
        "allow_unbind": 0,
        "unbind_deduct_hours": 0,
        "encryption_type": 1,
        "encryption_key": "加密密钥",
        "signature_required": 1,
        "signature_algorithm": "MD5",
        "signature_key": "签名密钥",
        "ip_whitelist": "192.168.1.1,192.168.1.2",
        "request_rate_limit": 100,
        "timeout": 60,
        "admin_id": 1,
        "create_time": "2023-01-01 12:00:00"
      }
    ]
  }
}
```

##### 更新应用
```
PUT /api/panel/applications/{id}
```
请求参数：
```json
{
  "name": "新应用名称",
  "device_binding": 0,  // 绑定类型：0-不绑定，1-设备绑定，2-IP绑定
  "status": 1,
  "description": "新应用描述",
  "logo_url": "https://example.com/new-logo.png",
  "version": "1.1.0",
  "download_url": "https://example.com/new-download",
  "website_url": "https://new-example.com",
  "contact_info": "new-contact@example.com",
  "notice": "应用公告内容",  // 应用公告内容，通过此字段更新应用公告
  "allow_trial": 0,
  "trial_amount": 0,
  "max_devices": 5,
  "heartbeat": 60,
  "allow_rebind": 0,  // 是否允许换绑：0-不允许，1-允许
  "allow_unbind": 0,  // 是否允许解绑：0-不允许，1-允许
  "unbind_deduct_hours": 0,  // 解绑扣除时长（小时），0表示不扣除
  "encryption_type": 1,  // 加密类型：0-不加密，1-AES加密，2-RSA加密，3-自定义加密
  "encryption_key": "新加密密钥",  // 加密密钥
  "signature_required": 1,  // 是否需要签名：0-不需要，1-需要
  "signature_algorithm": "SHA256",  // 签名算法：MD5/SHA1/SHA256等
  "signature_key": "新签名密钥",  // 签名密钥
  "ip_whitelist": "192.168.1.1,192.168.1.2,192.168.1.3",  // IP白名单，多个IP用逗号分隔，为空表示不限制
  "request_rate_limit": 200,  // 请求频率限制（次/分钟），0表示不限制
  "timeout": 30  // 请求超时时间（秒）
}
```
响应：
```json
{
  "code": 200,
  "message": "success"
}
```

##### 重置应用密钥
```
POST /api/panel/applications/{id}/reset-key
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "app_key": "新生成的应用密钥"
  }
}
```


```
响应：
```json
{
  "code": 200,
  "message": "success"
}
```

##### 更新应用API设置
```
PUT /api/panel/applications/{id}/api-settings
```
请求参数：
```json
{
  "encrypt_type": 1,
  "encrypt_key": "加密密钥",
  "sign_check": 1,
  "sign_key": "签名密钥",
  "ip_whitelist": "192.168.1.1,192.168.1.2",
  "request_limit": 100,
  "timeout": 60
}
```
响应：
```json
{
  "code": 200,
  "message": "success"
}
```

#### 应用变量API

##### 创建应用变量
```
POST /api/panel/app-variables
```
请求参数：
```json
{
  "app_id": 1,
  "name": "变量名称",
  "value": "变量值",
  "type": 0,  // 变量类型：0-公开变量，1-私有变量
  "description": "变量描述",
  "status": 1
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "admin_id": 1
  }
}
```

##### 获取应用变量列表
```
GET /api/panel/app-variables?app_id=1&type=0&page=1&limit=20
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "list": [
      {
        "id": 1,
        "app_id": 1,
        "name": "变量名称",
        "value": "变量值",
        "type": 0,
        "description": "变量描述",
        "status": 1,
        "create_time": "2023-01-01 12:00:00",
        "update_time": "2023-01-02 12:00:00"
      }
    ]
  }
}
```

##### 更新应用变量
```
PUT /api/panel/app-variables/{id}
```
请求参数：
```json
{
  "name": "新变量名称",
  "value": "新变量值",
  "type": 0,
  "description": "新变量描述",
  "status": 1
}
```
响应：
```json
{
  "code": 200,
  "message": "success"
}
```

##### 删除应用变量
```
DELETE /api/panel/app-variables/{id}
```
响应：
```json
{
  "code": 200,
  "message": "success"
}
```



#### 卡密类型API

##### 创建卡密类型
```
POST /api/panel/card-types
```
请求参数：
```json
{
  "name": "类型名称",
  "duration": 30,
  "time_unit": 1,  // 时间单位：0-小时，1-天，2-月，3-年
  "app_id": 1,
  "status": 1,
  "default_max_bind_count": 3  // 默认最大换绑/解绑次数限制，0表示不限制
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1
  }
}
```

##### 获取卡密类型列表
```
GET /api/panel/card-types?app_id=1
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 5,
    "list": [
      {
        "id": 1,
        "name": "月卡",
        "duration": 30,
        "time_unit": 1,
        "app_id": 1,
        "status": 1,
        "default_max_bind_count": 3,
        "admin_id": 1,
        "create_time": "2023-01-01 12:00:00"
      }
    ]
  }
}
```

##### 更新卡密类型
```
PUT /api/panel/card-types/{id}
```
请求参数：
```json
{
  "name": "类型名称",
  "duration": 30,
  "time_unit": 1,  // 时间单位：0-小时，1-天，2-月，3-年
  "app_id": 1,
  "status": 1,
  "default_max_bind_count": 3  // 默认最大换绑/解绑次数限制，0表示不限制
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

##### 删除卡密类型
```
DELETE /api/panel/card-types/{id}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

#### 卡密管理API

##### 生成卡密
```
POST /api/panel/cards/generate
```
请求参数：
```json
{
  "type_id": 1,
  "app_id": 1,
  "count": 100,
  "prefix": "VIP",  // 卡密前缀，可选参数。不需要则不上传
  "max_bind_count": 3  // 最大换绑/解绑次数限制，可选参数。不设置则使用卡密类型的默认值
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success": 100,
    "failed": 0
  }
}
```

##### 获取卡密列表
```
GET /api/panel/cards?app_id=1&type_id=1&status=0&page=1&limit=20
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "list": [
      {
        "id": 1,
        "card_no": "TEST123456",
        "type_id": 1,
        "app_id": 1,
        "status": 0,
        "admin_id": 1,
        "binding_info": null,  // 根据应用的绑定类型，显示设备ID或IP地址的JSON数据
        "bind_count": 0,  // 已使用的换绑/解绑次数
        "max_bind_count": 3,  // 最大换绑/解绑次数限制，0表示不限制
        "create_time": "2023-01-01 12:00:00",
        "activate_time": null,
        "expire_time": null
      }
    ]
  }
}
```

##### 导出卡密
```
GET /api/panel/cards/export?app_id=1&type_id=1&status=0
```
响应：CSV文件下载

##### 更换卡密
```
PUT /api/panel/cards/{id}/change
```
请求参数：
```json
{
  "app_id": 1
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "new_card_no": "NEW123456"
  }
}
```

##### 重置卡密
```
PUT /api/panel/cards/{id}/reset
```
请求参数：
```json
{
  "app_id": 1
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

##### 更新卡密
```
PUT /api/panel/cards/{id}
```
请求参数：
```json
{
  "type_id": 1,
  "app_id": 1,
  "status": 0,
  "max_bind_count": 3  // 最大换绑/解绑次数限制，0表示不限制
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

##### 删除卡密
```
DELETE /api/panel/cards/{id}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

#### 设备管理API

##### 获取设备列表
```
GET /api/panel/devices?status=1&page=1&limit=20
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 50,
    "list": [
      {
        "id": 1,
        "device_id": "DEVICE123456",
        "status": 1,
        "remark": "测试设备",
        "create_time": "2023-01-01 12:00:00",
        "last_login": "2023-01-02 12:00:00"
      }
    ]
  }
}
```

#### 客户端API

##### 验证应用
```
POST /api/client/verify-app
```
请求参数：
```json
{
  "app_key": "应用密钥",
  "timestamp": 1629789600
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "app_id": 1,
    "app_name": "应用名称",
    "logo_url": "https://example.com/logo.png",
    "version": "1.0.0",
    "website_url": "https://example.com",
    "contact_info": "contact@example.com",
    "encryption_type": 1,  // 加密类型：0-不加密，1-AES加密，2-RSA加密，3-自定义加密
    "signature_required": 1,  // 是否需要签名：0-不需要，1-需要
    "signature_algorithm": "MD5",  // 签名算法
    "request_rate_limit": 100,  // 请求频率限制（次/分钟）
    "timeout": 60  // 请求超时时间（秒）
  }
}
```

##### 激活卡密
```
POST /api/v1/client/activate
```
**说明**：激活卡密接口用于客户端首次使用卡密时进行激活，并将卡密与设备绑定。

请求参数：
```json
{
  "card_no": "TEST123456",
  "device_id": "DEVICE123456",
  "device_info": {"os":"Windows","version":"1.0"},
  "app_key": "应用密钥",
  "timestamp": 1629789600
  // 注意：IP地址由服务器自动获取，无需客户端提交
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "expire_time": "2023-02-01 12:00:00",
    "device_binding": 1,  // 绑定类型：0-不绑定，1-设备绑定，2-IP绑定
    "binding_info": {"type":1,"value":"DEVICE123456"},  // 根据应用的绑定类型，将设备ID或IP地址保存到卡密的绑定信息中
    "bind_count": 0,  // 已使用的换绑/解绑次数
    "max_bind_count": 3,  // 最大换绑/解绑次数限制，0表示不限制
    "can_rebind": true,  // 是否还可以换绑
    "can_unbind": true,  // 是否还可以解绑
    "days_left": 30,  // 剩余天数
    "message": "激活成功"  // 可选，服务器返回的消息
  }
}
```

##### 换绑卡密
```
POST /api/v1/client/rebind
```

**说明**：此接口仅在应用的最大设备数量（max_devices）设置为1且允许换绑（allow_rebind=1）时生效。如果应用允许多设备登录（max_devices>1），则不需要换绑，可以直接在新设备上激活使用。

此外，每张卡密有换绑/解绑次数限制（max_bind_count），每次成功换绑或解绑都会增加计数（bind_count）。当达到最大次数限制时，将无法继续换绑或解绑。如果max_bind_count设置为0，则表示不限制换绑/解绑次数。

请求参数：
```json
{
  "card_no": "TEST123456",
  "device_id": "NEWDEVICE123456",
  "device_info": {"os":"Windows","version":"1.0"},
  "app_key": "应用密钥",
  "timestamp": 1629789600
  // 注意：IP地址由服务器自动获取，无需客户端提交
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "expire_time": "2023-02-01 12:00:00",
    "device_binding": 1,  // 绑定类型：0-不绑定，1-设备绑定，2-IP绑定
    "binding_info": {"type":1,"value":"NEWDEVICE123456"},  // 更新后的绑定信息
    "bind_count": 1,  // 已使用的换绑/解绑次数（已增加）
    "max_bind_count": 3,  // 最大换绑/解绑次数限制，0表示不限制
    "can_rebind": true,  // 是否还可以换绑
    "can_unbind": true,  // 是否还可以解绑
    "days_left": 30,  // 剩余天数
    "message": "换绑成功"  // 可选，服务器返回的消息
  }
}
```

错误响应：
```json
{
  "code": 400,
  "message": "应用不允许换绑或最大设备数量大于1",
  "data": null
}
```

或

```json
{
  "code": 400,
  "message": "已达到最大换绑/解绑次数限制",
  "data": {
    "bind_count": 3,
    "max_bind_count": 3
  }
}
```

##### 解绑卡密
```
POST /api/v1/client/unbind
```

**说明**：此接口仅在应用允许解绑（allow_unbind=1）时生效。解绑后，卡密可以在其他设备上重新激活使用。如果应用设置了解绑扣除时长（unbind_deduct_hours），则解绑后卡密的有效期会相应减少。

此外，每张卡密有换绑/解绑次数限制（max_bind_count），每次成功换绑或解绑都会增加计数（bind_count）。当达到最大次数限制时，将无法继续换绑或解绑。如果max_bind_count设置为0，则表示不限制换绑/解绑次数。

请求参数：
```json
{
  "card_no": "TEST123456",
  "app_key": "应用密钥",
  "timestamp": 1629789600
  // 注意：IP地址由服务器自动获取，无需客户端提交
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "expire_time": "2023-02-01 12:00:00",
    "unbind_deduct_hours": 24,  // 解绑扣除的时长（小时），如果应用设置了解绑扣除时长
    "bind_count": 1,  // 已使用的换绑/解绑次数（已增加）
    "max_bind_count": 3,  // 最大换绑/解绑次数限制，0表示不限制
    "can_rebind": true,  // 是否还可以换绑
    "can_unbind": true,  // 是否还可以解绑
    "days_left": 30,  // 剩余天数
    "message": "解绑成功"  // 可选，服务器返回的消息
  }
}
```

错误响应：
```json
{
  "code": 400,
  "message": "应用不允许解绑",
  "data": null
}
```

或

```json
{
  "code": 400,
  "message": "已达到最大换绑/解绑次数限制",
  "data": {
    "bind_count": 3,
    "max_bind_count": 3
  }
}
```

##### 验证设备
```
POST /api/v1/client/verify
```
**说明**：验证设备接口用于客户端验证设备是否已绑定卡密，以及卡密的有效状态。

请求参数：
```json
{
  "device_id": "DEVICE123456",
  "card_no": "TEST123456",
  "app_key": "应用密钥",
  "timestamp": 1629789600
  // 注意：IP地址由服务器自动获取，无需客户端提交
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "status": 1,  // 卡密状态：0-未激活，1-已激活，2-已过期，3-已禁用
    "expire_time": "2023-02-01 12:00:00",
    "device_binding": 1,  // 绑定类型：0-不绑定，1-设备绑定，2-IP绑定
    "is_valid_binding": true,  // 当启用绑定时，表示当前设备/IP是否为有效的绑定（通过比对卡密中的绑定信息判断）
    "binding_info": {"type":1,"value":"DEVICE123456"},  // 从卡密信息中获取的绑定信息JSON数据
    "bind_count": 1,  // 已使用的换绑/解绑次数
    "max_bind_count": 3,  // 最大换绑/解绑次数限制，0表示不限制
    "can_rebind": true,  // 是否还可以换绑
    "can_unbind": true,  // 是否还可以解绑
    "days_left": 30,  // 剩余天数
    "message": "验证成功"  // 可选，服务器返回的消息
  }
}
```

##### 心跳
```
POST /api/v1/client/heartbeat
```
**说明**：心跳接口用于客户端定期向服务器发送在线状态，服务器可以通过心跳检测客户端是否在线，并返回服务器当前时间和卡密状态信息。建议客户端根据应用设置的心跳间隔（heartbeat字段）发送心跳请求，如果应用未设置心跳间隔，建议每1-5分钟发送一次。

请求参数：
```json
{
  "device_id": "DEVICE123456",
  "card_no": "TEST123456",
  "app_key": "应用密钥",
  "timestamp": 1629789600,
  "device_info": {"os":"Windows","version":"1.0","memory":"8GB","cpu":"Intel i5"},  // 可选，设备详细信息
  "client_time": "2023-01-01 12:00:00"  // 可选，客户端当前时间
  // 注意：IP地址由服务器自动获取，无需客户端提交
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "server_time": "2023-01-01 12:00:00",
    "status": 1,  // 卡密状态：0-未激活，1-已激活，2-已过期，3-已禁用
    "expire_time": "2023-02-01 12:00:00",
    "is_valid": true,  // 卡密是否有效
    "next_heartbeat": 5,  // 下次心跳间隔（分钟），来自应用的heartbeat设置
    "binding_info": {"type":1,"value":"DEVICE123456"},  // 绑定信息
    "days_left": 30,  // 剩余天数
    "message": "心跳成功"  // 可选，服务器返回的消息
  }
}
```

错误响应：
```json
{
  "code": 3001,
  "message": "卡密不存在",
  "data": null
}
```

或

```json
{
  "code": 3003,
  "message": "卡密已过期",
  "data": {
    "server_time": "2023-03-01 12:00:00",
    "expire_time": "2023-02-01 12:00:00"
  }
}
```

##### 获取应用公开变量
```
POST /api/v1/client/variables
```
**说明**：获取应用公开变量接口用于客户端获取应用的公开变量，无需认证即可访问。

请求参数：
```json
{
  "app_key": "应用密钥",
  "timestamp": 1629789600
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "variables": [
      {
        "name": "变量名称1",
        "value": "变量值1",
        "type": "string",
        "description": "变量描述1"
      },
      {
        "name": "变量名称2",
        "value": "变量值2",
        "type": "string",
        "description": "变量描述2"
      }
    ]
  }
}
```

##### 获取应用私有变量
```
POST /api/v1/client/private-variables
```
**说明**：获取应用私有变量接口用于客户端获取应用的私有变量，需要有效的卡密和设备ID才能访问。

请求参数：
```json
{
  "device_id": "DEVICE123456",
  "card_no": "TEST123456",
  "app_key": "应用密钥",
  "timestamp": 1629789600
  // 注意：IP地址由服务器自动获取，无需客户端提交
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "variables": [
      {
        "name": "私有变量名称1",
        "value": "私有变量值1",
        "type": "string",
        "description": "私有变量描述1"
      },
      {
        "name": "私有变量名称2",
        "value": "私有变量值2",
        "type": "string",
        "description": "私有变量描述2"
      }
    ]
  }
}
```

##### 获取应用公告
```
POST /api/v1/client/notice
```
**说明**：获取应用公告接口用于客户端获取应用的公告信息，无需认证即可访问。

请求参数：
```json
{
  "app_key": "应用密钥",
  "timestamp": 1629789600
}
```
响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "notice": "应用公告内容",
    "update_time": "2023-01-01 12:00:00"  // 公告更新时间
  }
}
```

##### 获取站点信息
```
GET /api/v1/site/info
```
**说明**：获取站点信息接口用于客户端获取网站的基本信息，如网站名称、描述等，无需认证即可访问。

请求参数：无

响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "name": "验证系统",
    "subtitle": "专业的软件授权验证系统",
    "description": "提供软件授权、验证、管理等服务",
    "keywords": "软件授权,验证系统,卡密管理",
    "copyright": "© 2023 验证系统. 保留所有权利."
  }
}
```

## 13. 安全措施

### 13.1 密码存储

- 使用bcrypt算法加密存储密码
- 密码加密强度系数为12
- 禁止在日志中记录明文密码

### 13.2 SQL注入防护

- 使用参数化查询
- 避免拼接SQL语句
- 使用ORM框架（GORM）进行数据库操作

### 13.3 XSS防护

- 输入验证和过滤
- 输出编码
- 使用CSP（Content Security Policy）

### 13.4 CSRF防护

- 使用CSRF Token
- 验证请求来源
- 关键操作二次确认

### 13.5 API安全

- 限流措施：根据应用设置的请求频率限制控制API调用频率
- 请求签名验证：支持MD5/SHA1/SHA256等多种签名算法
- IP白名单：可配置允许访问API的IP地址列表
- 数据加密：支持AES/RSA等多种加密方式保护数据传输安全
- 时间戳验证：防止重放攻击
- 请求超时设置：限制请求有效期

### 13.6 API加密与签名流程

#### 加密流程

1. **AES加密**：
   - 使用应用配置的encryption_key作为密钥
   - 加密模式：CBC
   - 填充方式：PKCS7
   - 加密对象：请求/响应的data字段内容

2. **RSA加密**：
   - 客户端使用服务端公钥加密数据
   - 服务端使用私钥解密数据
   - 加密对象：请求/响应的data字段内容

#### 签名流程

1. 按照字母顺序排序所有参数（不包括sign字段本身）
2. 将参数按照key=value格式拼接，参数之间使用&连接
3. 在拼接后的字符串末尾追加签名密钥：&key=signature_key
4. 使用指定的签名算法（MD5/SHA1/SHA256等）计算签名
5. 将签名结果添加到请求参数中：sign=签名结果

## 14. 部署与维护

### 14.1 部署环境要求

- **操作系统**：Linux（推荐CentOS 7+/Ubuntu 18.04+）或Windows Server 2016+
- **CPU**：2核+
- **内存**：4GB+
- **存储**：50GB+
- **网络**：公网IP，开放80/443端口

### 14.2 部署步骤

1. 安装Go环境（1.16+）
2. 安装MySQL或配置SQLite
3. 克隆代码仓库
4. 编译项目：`go build -o server main.go`
5. 配置config.yaml
6. 启动服务：`./server start`
7. 配置Nginx反向代理（可选）

### 14.2.1 配置文件示例

```yaml
# 服务器配置
server:
  # 服务器端口
  port: 8080
  # 运行模式：debug, release, test
  mode: release
  # 日志级别：debug, info, warn, error
  log_level: info
  # 静态资源路径
  static_path: ./public
  # 会话超时时间（小时）
  session_timeout: 24

# 数据库配置
database:
  # 数据库类型：mysql, sqlite
  type: sqlite
  # MySQL配置（当type=mysql时使用）
  mysql:
    host: localhost
    port: 3306
    username: root
    password: password
    database: verify_system
    charset: utf8mb4
    max_idle_conns: 10
    max_open_conns: 100
  # SQLite配置（当type=sqlite时使用）
  sqlite:
    path: ./data/database.db

# 安全配置
security:
  # JWT密钥
  jwt_secret: your_jwt_secret_key
  # 密码加密强度
  bcrypt_cost: 12
  # 允许失败登录次数
  max_login_attempts: 5
  # 登录锁定时间（分钟）
  login_lock_time: 30

# 应用配置
application:
  # 应用密钥长度
  key_length: 32
  # 最大应用数量（0表示不限制）
  max_count: 0
  # 默认状态（1-启用，0-禁用）
  default_status: 1

# 静态资源配置
static:
  # 是否使用embed嵌入静态资源
  use_embed: true
  # 静态资源路径（当use_embed为false时使用）
  path: "./static"
  # 静态资源URL前缀
  url_prefix: "/static/"

# 系统设置
system:
  # 网站基本信息
  site:
    # 网站名称
    name: "验证系统"
    # 网站副标题
    subtitle: "专业的软件授权验证系统"
    # 网站描述
    description: "提供软件授权、验证、管理等服务"
    # 网站关键词
    keywords: "软件授权,验证系统,卡密管理"
    # 网站版权信息
    copyright: "© 2023 验证系统. 保留所有权利."
  
  # 用户设置
  user:
    # 是否开启普通会员和VIP会员登录
    enable_login: true
    # 是否开放普通会员注册
    enable_register: true
    # 注册是否需要邀请码
    require_invite_code: false
    # 注册是否需要邮箱验证
    require_email_verification: true
    # 用户默认状态（1-启用，0-禁用）
    default_status: 1
  
  # 邮件设置
  mail:
    # 是否启用邮件功能
    enable: true
    # SMTP服务器地址
    smtp_host: "smtp.example.com"
    # SMTP服务器端口
    smtp_port: 587
    # 是否使用SSL/TLS
    smtp_secure: true
    # 发件人邮箱
    from_email: "noreply@example.com"
    # 发件人名称
    from_name: "验证系统"
    # SMTP用户名
    username: "noreply@example.com"
    # SMTP密码
    password: "your_smtp_password"
  
  # 缓存设置
  cache:
    # 缓存类型（memory, redis）
    type: "memory"
    # Redis配置（当type=redis时使用）
    redis:
      host: "localhost"
      port: 6379
      password: ""
      db: 0
      prefix: "verify_system:"
```

### 14.3 静态资源嵌入

系统使用Go的embed功能将静态资源嵌入到可执行文件中，具有以下优势：

- 简化部署，无需单独部署静态资源文件
- 提高安全性，防止静态资源被篡改
- 提高加载速度，减少磁盘IO
- 支持离线运行，不依赖外部文件

嵌入的静态资源包括：

- 前端页面文件（HTML、CSS、JavaScript）
- 图片、字体等资源文件
- 默认配置文件

### 14.4 系统设置初始化

系统首次启动时，会自动初始化以下系统设置：

| 键名 | 值 | 类型 | 分组 | 描述 |
| --- | --- | --- | --- | --- |
| system_name | 网络验证系统 | string | system | 系统名称 |
| admin_email | admin@example.com | string | system | 管理员邮箱 |
| demo_mode | false | boolean | system | 演示模式 |
| card_prefix | VIP | string | card | 卡密默认前缀 |
| card_length | 16 | number | card | 卡密长度 |
| batch_size | 100 | number | card | 卡密生成批次大小 |
| max_types_per_app | 10 | number | card | 每个应用的最大卡密类型数量 |
| default_expire_duration | 30 | number | card | 默认有效期 |
| default_time_unit | 1 | number | card | 默认时间单位 |
| default_user_status | 1 | number | user | 默认用户状态 |
| password_expire_duration | 90 | number | user | 密码过期时长 |
| password_expire_time_unit | 1 | number | user | 密码过期时间单位 |

### 14.5 备份策略

- 数据库每日自动备份
- 配置文件定期备份
- 备份文件异地存储

### 14.6 监控与告警

- 服务状态监控
- 资源使用率监控
- 异常登录告警
- 系统错误告警

## 15. 术语表

| 术语 | 描述 |
|------|------|
| 用户 | 系统的使用者，可以进行登录、应用管理、卡密管理等操作，分为系统管理员、普通会员和VIP会员 |
| 应用 | 需要验证的软件或服务，每个应用拥有独立的卡密和设备管理 |
| 应用密钥 | 用于标识和验证应用的唯一密钥 |
| 卡密 | 用于激活和验证软件的密钥，与特定应用关联 |
| 卡密类型 | 定义卡密的有效期和其他属性的分类，每个应用可以有多种卡密类型 |
| 设备 | 安装并使用软件的终端设备，不与特定应用或卡密关联 |
| 激活 | 使用卡密激活软件的过程 |
| 绑定方式 | 应用的一个属性，决定该应用下的卡密是否需要绑定到特定设备或IP地址 |
| 设备绑定 | 将卡密与特定设备关联的过程，仅当应用启用设备绑定时适用 |
| IP绑定 | 将卡密与特定IP地址关联的过程，仅当应用启用IP绑定时适用。IP地址由服务器自动从请求中获取，无需客户端提交 |
| 验证 | 确认设备或IP地址是否有权使用特定应用的过程，通过检查设备或IP地址是否符合卡密的绑定信息 |

## 16. 系统架构与流程图

### 16.1 系统架构图

```
+----------------------------------+
|            客户端                |
|  +-------------+  +----------+  |
|  | Web界面     |  | 软件客户端 |  |
|  +-------------+  +----------+  |
+----------------------------------+
            |            |
            v            v
+----------------------------------+
|           API网关               |
|  +-------------+  +----------+  |
|  | 认证        |  | 限流      |  |
|  +-------------+  +----------+  |
|  +-------------+               |
|  | IP获取      |               |
|  +-------------+               |
+----------------------------------+
            |
            v
+----------------------------------+
|           应用服务层             |
|  +-------------+  +----------+  |
|  | 用户后台   |  | 应用管理  |  |
|  +-------------+  +----------+  |
|  +-------------+  +----------+  |
|  | 卡密管理     |  | 设备管理  |  |
|  +-------------+  +----------+  |
+----------------------------------+
            |
            v
+----------------------------------+
|           数据服务层             |
|  +-------------+  +----------+  |
|  | MySQL/SQLite|  | 缓存      |  |
|  +-------------+  +----------+  |
+----------------------------------+
```

### 16.2 IP获取实现说明

在IP绑定功能中，系统通过API网关自动获取客户端的真实IP地址，无需客户端主动提交。实现方式如下：

1. 系统优先从HTTP请求头中获取X-Forwarded-For、X-Real-IP等标准代理头信息
2. 如果请求头中没有代理信息，则使用TCP连接的远程地址作为客户端IP
3. 对于多级代理情况，系统会智能分析代理链并提取最原始的客户端IP
4. 获取到的IP地址会在服务端进行格式验证和安全检查，防止IP伪造
5. 验证通过后的IP地址用于IP绑定功能，确保卡密安全

这种服务端自动获取IP的方式可以有效防止客户端伪造IP地址，提高系统安全性。

### 16.3 卡密激活流程图

```
+-------------+     +-------------+     +-------------+
|   客户端    |     |   服务端    |     |   数据库    |
+-------------+     +-------------+     +-------------+
      |                    |                   |
      | 1.提交卡密、设备ID |                   |
      | 和应用标识        |                   |
      |------------------->|                   |
      |                    | 1a.自动获取客户端IP|
      |                    |----------------   |
      |                    |                |  |
      |                    |<---------------   |
      |                    |                   |
      |                    | 2.验证应用有效性  |
      |                    |------------------>|
      |                    |                   |
      |                    | 3.返回应用信息    |
      |                    |<------------------|
      |                    |                   |
      |                    | 4.验证卡密有效性  |
      |                    |------------------>|
      |                    |                   |
      |                    | 5.返回卡密信息    |
      |                    |<------------------|
      |                    |                   |
      |                    | 6.检查卡密状态    |
      |                    |----------------   |
      |                    |                |  |
      |                    |<---------------   |
      |                    |                   |
      |                    | 7.检查卡密是否属于该应用|
      |                    |----------------   |
      |                    |                |  |
      |                    |<---------------   |
      |                    |                   |
      |                    | 8.检查应用的绑定方式设置|
      |                    |----------------   |
      |                    |                |  |
      |                    |<---------------   |
      |                    |                   |
      |                    | 9a.如需设备绑定，使用设备ID|
      |                    |----------------   |
      |                    |                |  |
      |                    |<---------------   |
      |                    |                   |
      |                    | 9b.如需IP绑定，使用获取的IP|
      |                    |----------------   |
      |                    |                |  |
      |                    |<---------------   |
      |                    |                   |
      |                    | 9c.将绑定信息保存到卡密中|
      |                    |------------------>|
      |                    |                   |
      |                    | 10.更新卡密状态   |
      |                    |------------------>|
      |                    |                   |
      | 11.返回激活结果    |                   |
      |<-------------------|                   |
      |                    |                   |
```

## 17. 开发流程与规范

### 17.1 Git分支管理

- **master**: 主分支，保持稳定可发布状态
- **develop**: 开发分支，最新开发代码
- **feature/xxx**: 功能分支，用于开发新功能
- **bugfix/xxx**: 修复分支，用于修复bug
- **release/x.x.x**: 发布分支，用于版本发布

### 17.2 代码审查流程

1. 开发者提交Pull Request
2. 至少一名团队成员进行代码审查
3. 通过自动化测试
4. 审查通过后合并到目标分支

### 17.3 编码规范

- 遵循Go官方编码规范
- 使用gofmt格式化代码
- 编写单元测试，保持测试覆盖率
- 注释清晰，特别是公开API

### 17.4 持续集成/持续部署

- 使用GitHub Actions进行CI/CD
- 每次提交自动运行测试
- 合并到develop分支自动部署到测试环境
- 合并到master分支自动部署到生产环境

## 18. 项目时间线

```
项目周期: 8周
+----+----+----+----+----+----+----+----+
|周1 |周2 |周3 |周4 |周5 |周6 |周7 |周8 |
+----+----+----+----+----+----+----+----+
|    |    |    |    |    |    |    |    |
| 项目初始化  |    核心功能开发    |    |
|    |    |    |    |    |    |    |    |
+----+----+----+----+----+----+----+----+
|    |    |    |    |    |    |    |    |
|    |    |    |    |    |用户后台开发|
|    |    |    |    |    |    |    |    |
+----+----+----+----+----+----+----+----+
|    |    |    |    |    |    |    |    |
|    |    |    |    |    |    |前端开发与优化|
|    |    |    |    |    |    |    |    |
+----+----+----+----+----+----+----+----+
|    |    |    |    |    |    |    |    |
|    |    |    |    |    |    |    |测试|
|    |    |    |    |    |    |    |部署|
+----+----+----+----+----+----+----+----+
```

## 19. 常见问题（FAQ）

### 19.1 开发相关

**Q: 如何处理多数据库支持？**  
A: 系统使用GORM作为ORM框架，通过配置文件中的database.type参数切换数据库类型。代码中使用统一的数据库接口，底层实现根据配置自动选择MySQL或SQLite。

**Q: 如何实现应用管理？**  
A: 系统提供应用管理功能，用户可以创建多个应用，每个应用有独立的应用密钥和配置。每个应用可以拥有自己的卡密类型和卡密，实现多应用独立管理。

**Q: 如何实现卡密管理？**  
A: 系统通过卡密管理功能创建和管理卡密，可以按应用筛选卡密，设置卡密的有效期和使用状态，方便用户进行管理和监控。每个应用的卡密是相互独立的。

**Q: 如何保证卡密的唯一性和安全性？**  
A: 卡密生成使用UUID+自定义算法，确保唯一性；存储时使用哈希加盐处理，防止泄露；激活时需从卡密信息中获取绑定信息进行验证，并验证应用ID，防止重复使用和跨应用使用。

### 19.2 部署相关

**Q: 如何从SQLite迁移到MySQL？**  
A: 修改config.yaml中的database.type为mysql，并配置相应的连接参数。系统会自动处理数据库连接和模型映射。

**Q: 如何备份和恢复数据？**  
A: MySQL使用mysqldump工具，SQLite直接复制数据库文件。系统提供内置的备份功能，可在用户后台操作。

**Q: 如何处理高并发场景？**  
A: 系统设计考虑了并发处理，使用连接池、缓存和限流措施。对于更高并发需求，可配置负载均衡和读写分离。

### 19.3 使用相关

**Q: 如何管理多个应用的设备？**  
A: 用户可在用户后台的"设备管理"模块中查看、解绑和管理设备，包括查看设备状态和登录记录。设备不与特定应用绑定，但卡密可以根据应用的绑定方式设置与设备或IP地址关联。

**Q: 如何设置应用的绑定方式？**
A: 在创建或更新应用时，可以设置device_binding参数（0-不绑定，1-设备绑定，2-IP绑定）。当应用开启设备绑定时，该应用下的所有卡密激活时都需要绑定设备；当应用开启IP绑定时，卡密将绑定到特定IP地址；当应用关闭绑定时，卡密可以在多个设备或IP地址上使用。

**Q: 如何处理卡密过期？**  
A: 系统有定时任务检查卡密状态，过期后自动更新状态。用户可在卡密管理中按应用筛选查看过期卡密并进行相应处理。

**Q: 如何为不同应用设置不同的卡密规则？**  
A: 用户可以在"卡密设置"中为每个应用单独配置卡密类型、有效期和生成规则，满足不同应用的需求。

**Q: 如何设置应用的绑定方式？**
A: 用户可以在创建或更新应用时设置"绑定方式"选项。有三种选择：不绑定(0)、设备绑定(1)或IP绑定(2)。启用设备绑定后，该应用下的所有卡密激活时都会绑定到特定设备，其他设备无法使用这些卡密；启用IP绑定后，卡密将绑定到特定IP地址，其他IP地址无法使用这些卡密；如果选择不绑定，则该应用下的卡密可以在多个设备或IP地址上使用。

**Q: 设备如何使用多个应用或卡密？**  
A: 设备不再与特定应用绑定，而是根据应用的绑定方式设置决定是否需要绑定卡密。如果应用未启用任何绑定，则设备可以自由使用该应用的任何卡密；如果应用启用了设备绑定，则设备使用的卡密将与该设备绑定，其他设备无法使用该卡密；如果应用启用了IP绑定，则卡密将与激活时的IP地址绑定，其他IP地址无法使用该卡密。同一设备可以使用多个不同应用的卡密。

**Q: 如何监控系统运行状态？**  
A: 系统提供实时监控面板，展示服务器资源使用、请求量、错误率等指标。同时支持日志查询和告警设置。

## 20. 参考资料

### 20.1 技术文档

- **Go语言**：[Go官方文档](https://golang.org/doc/)
- **Gin框架**：[Gin Web Framework](https://github.com/gin-gonic/gin)
- **Cobra命令行**：[Cobra GitHub](https://github.com/spf13/cobra)
- **GORM**：[GORM官方文档](https://gorm.io/docs/)
- **Viper配置**：[Viper GitHub](https://github.com/spf13/viper)
- **Logrus日志**：[Logrus GitHub](https://github.com/sirupsen/logrus)
- **JWT认证**：[JWT介绍](https://jwt.io/introduction)
- **Go Embed**：[Go Embed文档](https://golang.org/pkg/embed/)

## 21. 总结

本开发计划详细描述了网络验证系统的开发流程、技术栈、功能模块和时间安排。文档涵盖了从项目概述到具体实现细节，包括数据库设计、API接口规范、安全措施、部署维护等方面。系统支持多应用管理，每个应用拥有独立的卡密和设备管理，满足不同应用的验证需求。通过合理的规划和有效的执行，预计可以在8周内完成系统的开发和部署，交付一个功能完善、界面美观、性能稳定的网络验证系统。

文档提供了系统架构图、业务流程图和时间线，直观展示了系统设计和开发计划。同时，通过术语表和常见问题解答，帮助团队成员更好地理解项目需求和技术细节。参考资料部分提供了相关技术文档和学习资源的链接，便于开发人员在开发过程中查阅。

后续开发过程中，团队应严格遵循本文档中的规范和流程，同时保持灵活性，根据实际情况进行必要的调整。通过有效的沟通和协作，确保项目按时高质量完成。